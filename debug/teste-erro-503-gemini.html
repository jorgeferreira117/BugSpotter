<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Erro 503 Gemini API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>游댢 Teste - Tratamento de Erro 503 Gemini API</h1>
        
        <div class="info">
            <strong>Objetivo:</strong> Verificar se o AIService est치 tratando adequadamente erros 503 (modelo sobrecarregado) da API Gemini com retry e fallback.
        </div>

        <div class="test-section">
            <h3>1. Simular Erro HTTP que Gera Relat칩rio AI</h3>
            <p>Gera um erro HTTP que ser치 processado pela AI (pode resultar em erro 503 se a API estiver sobrecarregada):</p>
            <button onclick="gerarErroParaAI()">Gerar Erro HTTP para AI</button>
            <div id="resultado-ai"></div>
        </div>

        <div class="test-section">
            <h3>2. Verificar Status da AI</h3>
            <p>Verifica se a AI est치 pausada devido a erros 503:</p>
            <button onclick="verificarStatusAI()">Verificar Status AI</button>
            <div id="status-ai"></div>
        </div>

        <div class="test-section">
            <h3>3. Testar Configura칞칚o AI</h3>
            <p>Testa se a AI est치 configurada corretamente:</p>
            <button onclick="testarConfiguracaoAI()">Testar Configura칞칚o</button>
            <div id="config-ai"></div>
        </div>

        <div class="test-section">
            <h3>4. Logs do Console</h3>
            <p>Logs capturados do console (incluindo tratamento de erro 503):</p>
            <button onclick="limparLogs()">Limpar Logs</button>
            <div id="console-logs" class="log"></div>
        </div>
    </div>

    <script>
        // Capturar logs do console
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        const originalConsoleLog = console.log;
        
        let logs = [];
        
        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateLogsDisplay();
        }
        
        console.error = function(...args) {
            addLog('error', args.join(' '));
            originalConsoleError.apply(console, args);
        };
        
        console.warn = function(...args) {
            addLog('warn', args.join(' '));
            originalConsoleWarn.apply(console, args);
        };
        
        console.log = function(...args) {
            addLog('log', args.join(' '));
            originalConsoleLog.apply(console, args);
        };
        
        function updateLogsDisplay() {
            const logsDiv = document.getElementById('console-logs');
            logsDiv.textContent = logs.slice(-20).join('\n'); // 칔ltimos 20 logs
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function limparLogs() {
            logs = [];
            updateLogsDisplay();
        }

        // Fun칞칚o para gerar erro que ser치 processado pela AI
        async function gerarErroParaAI() {
            const resultDiv = document.getElementById('resultado-ai');
            resultDiv.innerHTML = '<div class="info">Gerando erro HTTP que ser치 processado pela AI...</div>';
            
            try {
                // Gerar erro HTTP 500 que ser치 capturado pelo BugSpotter
                const response = await fetch('/api/teste-erro-500', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        teste: 'erro-503-gemini',
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('Erro HTTP gerado para teste:', error.message);
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>Erro HTTP gerado:</strong> ${error.message}<br>
                        <small>Este erro ser치 processado pelo BugSpotter e pode gerar relat칩rio AI (ou erro 503 se API sobrecarregada)</small>
                    </div>
                `;
                
                // Aguardar um pouco para ver se h치 logs de AI
                setTimeout(() => {
                    resultDiv.innerHTML += '<div class="info">Verifique os logs do console para ver o tratamento do erro 503 da AI.</div>';
                }, 2000);
            }
        }

        // Fun칞칚o para verificar status da AI
        async function verificarStatusAI() {
            const statusDiv = document.getElementById('status-ai');
            statusDiv.innerHTML = '<div class="info">Verificando status da AI...</div>';
            
            try {
                // Verificar se existe AIService no contexto
                if (typeof window.AIService !== 'undefined') {
                    const aiService = new window.AIService();
                    await aiService.initialize();
                    
                    const isPaused = await aiService.shouldPauseAI();
                    const isConfigured = aiService.isConfigured();
                    
                    statusDiv.innerHTML = `
                        <div class="${isPaused ? 'error' : 'success'}">
                            <strong>Status AI:</strong><br>
                            Configurada: ${isConfigured ? 'Sim' : 'N칚o'}<br>
                            Pausada: ${isPaused ? 'Sim (devido a erros)' : 'N칚o'}<br>
                            Provider: ${aiService.provider}
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = '<div class="error">AIService n칚o encontrado no contexto da p치gina.</div>';
                }
            } catch (error) {
                console.error('Erro ao verificar status AI:', error);
                statusDiv.innerHTML = `<div class="error">Erro ao verificar status: ${error.message}</div>`;
            }
        }

        // Fun칞칚o para testar configura칞칚o da AI
        async function testarConfiguracaoAI() {
            const configDiv = document.getElementById('config-ai');
            configDiv.innerHTML = '<div class="info">Testando configura칞칚o da AI...</div>';
            
            try {
                if (typeof window.AIService !== 'undefined') {
                    const aiService = new window.AIService();
                    await aiService.initialize();
                    
                    // Tentar testar conex칚o (pode resultar em erro 503)
                    const testResult = await aiService.testConnection();
                    
                    configDiv.innerHTML = `
                        <div class="success">
                            <strong>Teste de Conex칚o:</strong><br>
                            Resultado: ${JSON.stringify(testResult, null, 2)}
                        </div>
                    `;
                } else {
                    configDiv.innerHTML = '<div class="error">AIService n칚o encontrado.</div>';
                }
            } catch (error) {
                console.error('Erro no teste de configura칞칚o AI:', error);
                configDiv.innerHTML = `
                    <div class="error">
                        <strong>Erro no teste:</strong> ${error.message}<br>
                        <small>Se for erro 503, verifique os logs para ver o tratamento de retry.</small>
                    </div>
                `;
            }
        }

        // Inicializar p치gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('P치gina de teste de erro 503 Gemini carregada');
            addLog('info', 'P치gina de teste iniciada - monitorando erros 503 da API Gemini');
        });
    </script>
</body>
</html>