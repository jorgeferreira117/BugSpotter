<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Valida√ß√£o - Logs para AI</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .validation-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #28a745;
        }
        .button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40,167,69,0.3);
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40,167,69,0.4);
        }
        .button.error {
            background: linear-gradient(45deg, #dc3545, #c82333);
            box-shadow: 0 4px 15px rgba(220,53,69,0.3);
        }
        .button.error:hover {
            box-shadow: 0 6px 20px rgba(220,53,69,0.4);
        }
        .button.warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            box-shadow: 0 4px 15px rgba(255,193,7,0.3);
        }
        .button.warning:hover {
            box-shadow: 0 6px 20px rgba(255,193,7,0.4);
        }
        .results {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
        }
        .expected {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .timestamp {
            font-size: 0.8em;
            color: #666;
        }
        .ai-report {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .validation-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .validation-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Valida√ß√£o - Logs para AI</h1>
        
        <div class="validation-section">
            <h3>üìã Objetivo da Valida√ß√£o</h3>
            <p>Verificar se os logs HTTP com erros 400+ e logs de console (warnings/errors) est√£o sendo corretamente enviados para a AI e inclu√≠dos na constru√ß√£o do relat√≥rio.</p>
            
            <div class="expected">
                <strong>‚úÖ O QUE DEVE SER ENVIADO PARA A AI:</strong>
                <div class="validation-item">
                    <span class="validation-icon">üåê</span>
                    <span><strong>Erros HTTP 400+:</strong> URL, m√©todo, status, headers, responseBody</span>
                </div>
                <div class="validation-item">
                    <span class="validation-icon">‚ö†Ô∏è</span>
                    <span><strong>Console Warnings:</strong> Mensagem, timestamp, stackTrace</span>
                </div>
                <div class="validation-item">
                    <span class="validation-icon">‚ùå</span>
                    <span><strong>Console Errors:</strong> Mensagem, timestamp, stackTrace</span>
                </div>
                <div class="validation-item">
                    <span class="validation-icon">üìä</span>
                    <span><strong>Contexto Adicional:</strong> Logs recentes (30s antes do erro)</span>
                </div>
            </div>
        </div>

        <div class="validation-section">
            <h3>üß™ Testes de Valida√ß√£o</h3>
            
            <h4>1. Erros HTTP com Diferentes Status</h4>
            <button class="button error" onclick="testHttp400()">HTTP 400 - Bad Request</button>
            <button class="button error" onclick="testHttp404()">HTTP 404 - Not Found</button>
            <button class="button error" onclick="testHttp500()">HTTP 500 - Server Error</button>
            
            <h4>2. Logs de Console</h4>
            <button class="button warning" onclick="testConsoleWarn()">console.warn() - Warning</button>
            <button class="button error" onclick="testConsoleError()">console.error() - Error</button>
            
            <h4>3. Cen√°rio Combinado</h4>
            <button class="button" onclick="testCombinedScenario()">üî• Cen√°rio Completo (HTTP + Console)</button>
            
            <div id="test-results" class="results"></div>
        </div>

        <div class="validation-section">
            <h3>üîç Verifica√ß√£o dos Dados Enviados para AI</h3>
            <button class="button" onclick="checkAIReports()">üìä Verificar Relat√≥rios AI Gerados</button>
            <button class="button" onclick="analyzeAIPrompt()">üîç Analisar Dados do Prompt AI</button>
            <button class="button" onclick="validateContextData()">üìã Validar Dados de Contexto</button>
            
            <div id="ai-analysis" class="results"></div>
        </div>

        <div class="validation-section">
            <h3>‚öôÔ∏è Configura√ß√µes AI</h3>
            <button class="button" onclick="checkAISettings()">üîß Verificar Configura√ß√µes AI</button>
            <button class="button" onclick="clearResults()">üßπ Limpar Resultados</button>
            
            <div id="settings-info" class="results"></div>
        </div>
    </div>

    <script>
        let testCounter = 0;
        
        function addResult(message, type = 'info') {
            const results = document.getElementById('test-results');
            const timestamp = new Date().toISOString();
            const className = type;
            
            results.innerHTML += `
                <div class="${className}">
                    <span class="timestamp">[${timestamp}]</span> ${message}
                </div>
            `;
            results.scrollTop = results.scrollHeight;
        }
        
        function addAIAnalysis(message, type = 'info') {
            const analysis = document.getElementById('ai-analysis');
            const timestamp = new Date().toISOString();
            
            analysis.innerHTML += `
                <div class="${type}">
                    <span class="timestamp">[${timestamp}]</span> ${message}
                </div>
            `;
            analysis.scrollTop = analysis.scrollHeight;
        }
        
        // Testes de HTTP
        async function testHttp400() {
            testCounter++;
            addResult(`üß™ Teste ${testCounter}: Gerando HTTP 400 - Bad Request`);
            
            try {
                const response = await fetch('https://httpbin.org/status/400', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Test-Header': 'ValidationTest'
                    },
                    body: JSON.stringify({
                        test: 'validation',
                        timestamp: new Date().toISOString(),
                        errorType: 'BadRequest'
                    })
                });
                
                addResult(`HTTP ${response.status}: ${response.statusText}`, 'error');
                addResult('‚úÖ Erro HTTP 400 gerado. Deve ser enviado para AI (status >= 400)', 'success');
                
            } catch (error) {
                addResult(`Erro de rede: ${error.message}`, 'error');
            }
        }
        
        async function testHttp404() {
            testCounter++;
            addResult(`üß™ Teste ${testCounter}: Gerando HTTP 404 - Not Found`);
            
            try {
                const response = await fetch('https://httpbin.org/status/404');
                addResult(`HTTP ${response.status}: ${response.statusText}`, 'error');
                addResult('‚úÖ Erro HTTP 404 gerado. Deve ser enviado para AI (status >= 400)', 'success');
                
            } catch (error) {
                addResult(`Erro de rede: ${error.message}`, 'error');
            }
        }
        
        async function testHttp500() {
            testCounter++;
            addResult(`üß™ Teste ${testCounter}: Gerando HTTP 500 - Server Error`);
            
            try {
                const response = await fetch('https://httpbin.org/status/500');
                addResult(`HTTP ${response.status}: ${response.statusText}`, 'error');
                addResult('‚úÖ Erro HTTP 500 gerado. Deve ser enviado para AI (status >= 400)', 'success');
                
            } catch (error) {
                addResult(`Erro de rede: ${error.message}`, 'error');
            }
        }
        
        // Testes de Console
        function testConsoleWarn() {
            testCounter++;
            addResult(`üß™ Teste ${testCounter}: Gerando console.warn()`);
            
            console.warn('‚ö†Ô∏è TESTE VALIDA√á√ÉO: Este warning deve ser capturado e enviado para AI', {
                testId: testCounter,
                timestamp: new Date().toISOString(),
                type: 'validation-warning',
                details: 'Warning gerado para teste de valida√ß√£o AI'
            });
            
            addResult('‚úÖ console.warn() executado. Deve ser capturado e inclu√≠do no contexto AI', 'warning');
        }
        
        function testConsoleError() {
            testCounter++;
            addResult(`üß™ Teste ${testCounter}: Gerando console.error()`);
            
            console.error('‚ùå TESTE VALIDA√á√ÉO: Este erro deve ser capturado e enviado para AI', {
                testId: testCounter,
                timestamp: new Date().toISOString(),
                type: 'validation-error',
                details: 'Erro gerado para teste de valida√ß√£o AI',
                stackTrace: new Error().stack
            });
            
            addResult('‚úÖ console.error() executado. Deve ser capturado e inclu√≠do no contexto AI', 'error');
        }
        
        // Cen√°rio combinado
        async function testCombinedScenario() {
            testCounter++;
            addResult(`üß™ Teste ${testCounter}: Cen√°rio Completo - HTTP + Console`);
            
            // 1. Gerar warning primeiro
            console.warn('‚ö†Ô∏è CEN√ÅRIO COMPLETO: Warning antes do erro HTTP', {
                scenario: 'combined-test',
                step: 1,
                timestamp: new Date().toISOString()
            });
            
            // 2. Aguardar um pouco
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 3. Gerar erro de console
            console.error('‚ùå CEN√ÅRIO COMPLETO: Erro antes da requisi√ß√£o HTTP', {
                scenario: 'combined-test',
                step: 2,
                timestamp: new Date().toISOString()
            });
            
            // 4. Aguardar um pouco
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 5. Gerar erro HTTP
            try {
                const response = await fetch('https://httpbin.org/status/500', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Scenario': 'CombinedTest'
                    },
                    body: JSON.stringify({
                        scenario: 'combined-test',
                        step: 3,
                        timestamp: new Date().toISOString(),
                        previousLogs: ['warning', 'error']
                    })
                });
                
                addResult(`HTTP ${response.status}: ${response.statusText}`, 'error');
                addResult('‚úÖ Cen√°rio completo executado. AI deve receber: warning + error + HTTP 500 + contexto', 'success');
                
            } catch (error) {
                addResult(`Erro de rede: ${error.message}`, 'error');
            }
        }
        
        // Verifica√ß√µes AI
        async function checkAIReports() {
            addAIAnalysis('üîç Verificando relat√≥rios AI gerados...');
            
            try {
                // Verificar se estamos no contexto da extens√£o
                if (typeof chrome === 'undefined' || !chrome.storage) {
                    addAIAnalysis('‚ö†Ô∏è Esta p√°gina deve ser executada no contexto da extens√£o Chrome', 'warning');
                    addAIAnalysis('üìã Para verificar relat√≥rios AI:', 'info');
                    addAIAnalysis('  1. Abra o DevTools (F12)', 'info');
                    addAIAnalysis('  2. V√° para Application > Storage > Local Storage', 'info');
                    addAIAnalysis('  3. Procure por chaves que come√ßam com "ai-reports-"', 'info');
                    return;
                }
                
                // Verificar storage local para relat√≥rios AI
                const keys = await chrome.storage.local.get(null);
                const aiReportKeys = Object.keys(keys).filter(key => key.startsWith('ai-reports-'));
                
                if (aiReportKeys.length === 0) {
                    addAIAnalysis('‚ùå Nenhum relat√≥rio AI encontrado no storage', 'error');
                    return;
                }
                
                addAIAnalysis(`üìä Encontrados ${aiReportKeys.length} conjuntos de relat√≥rios AI`, 'success');
                
                let totalReports = 0;
                for (const key of aiReportKeys) {
                    const reports = keys[key] || [];
                    totalReports += reports.length;
                    
                    addAIAnalysis(`üìã ${key}: ${reports.length} relat√≥rios`);
                    
                    // Mostrar √∫ltimos relat√≥rios
                    reports.slice(-3).forEach((report, index) => {
                        addAIAnalysis(`  ${index + 1}. ${report.title} (${report.createdAt})`, 'info');
                        if (report.originalError) {
                            addAIAnalysis(`     URL: ${report.originalError.url}`, 'info');
                            addAIAnalysis(`     Status: ${report.originalError.status}`, 'info');
                        }
                    });
                }
                
                addAIAnalysis(`‚úÖ Total de relat√≥rios AI: ${totalReports}`, 'success');
                
            } catch (error) {
                addAIAnalysis(`‚ùå Erro ao verificar relat√≥rios AI: ${error.message}`, 'error');
            }
        }
        
        async function analyzeAIPrompt() {
            addAIAnalysis('üîç Analisando estrutura do prompt enviado para AI...');
            
            // Simular an√°lise do prompt baseado no c√≥digo do AIService
            const promptStructure = {
                'URL': '‚úÖ Inclu√≠do no prompt',
                'M√©todo HTTP': '‚úÖ Inclu√≠do no prompt',
                'Status Code': '‚úÖ Inclu√≠do no prompt',
                'Status Text': '‚úÖ Inclu√≠do no prompt',
                'Headers': '‚úÖ Inclu√≠do no prompt (JSON)',
                'Response Body': '‚úÖ Inclu√≠do no prompt',
                'Console Logs': '‚úÖ Inclu√≠do no contexto adicional (JSON)',
                'Network Requests': '‚úÖ Inclu√≠do no contexto adicional (JSON)',
                'JavaScript Errors': '‚úÖ Inclu√≠do no contexto adicional (JSON)',
                'User Agent': '‚úÖ Inclu√≠do no prompt',
                'Referrer': '‚úÖ Inclu√≠do no prompt',
                'Timestamp': '‚úÖ Inclu√≠do no prompt'
            };
            
            addAIAnalysis('üìã Estrutura do Prompt AI:', 'success');
            Object.entries(promptStructure).forEach(([key, value]) => {
                addAIAnalysis(`  ${key}: ${value}`, 'info');
            });
            
            addAIAnalysis('‚úÖ Todos os dados relevantes s√£o inclu√≠dos no prompt da AI', 'success');
        }
        
        async function validateContextData() {
            addAIAnalysis('üîç Validando coleta de dados de contexto...');
            
            try {
                // Verificar logs persistentes
                const savedLogs = localStorage.getItem('bugSpotter_logs');
                if (savedLogs) {
                    const logsData = JSON.parse(savedLogs);
                    const logs = logsData.logs || [];
                    
                    const errorLogs = logs.filter(log => log.level === 'error');
                    const warningLogs = logs.filter(log => log.level === 'warn' || log.level === 'warning');
                    const httpLogs = logs.filter(log => 
                        log.text && (log.text.includes('HTTP ERROR') || log.text.includes('NETWORK'))
                    );
                    
                    addAIAnalysis(`üìä Logs dispon√≠veis para contexto:`, 'success');
                    addAIAnalysis(`  Total de logs: ${logs.length}`, 'info');
                    addAIAnalysis(`  Logs de erro: ${errorLogs.length}`, 'info');
                    addAIAnalysis(`  Logs de warning: ${warningLogs.length}`, 'info');
                    addAIAnalysis(`  Logs HTTP: ${httpLogs.length}`, 'info');
                    
                    // Mostrar exemplos recentes
                    if (errorLogs.length > 0) {
                        addAIAnalysis('üìã √öltimos erros capturados:', 'info');
                        errorLogs.slice(-3).forEach((log, index) => {
                            addAIAnalysis(`  ${index + 1}. ${log.timestamp}: ${log.text || log.args?.[0] || 'N/A'}`, 'info');
                        });
                    }
                    
                    addAIAnalysis('‚úÖ Dados de contexto est√£o sendo coletados corretamente', 'success');
                } else {
                    addAIAnalysis('‚ùå Nenhum log encontrado no localStorage', 'error');
                }
                
            } catch (error) {
                addAIAnalysis(`‚ùå Erro ao validar contexto: ${error.message}`, 'error');
            }
        }
        
        async function checkAISettings() {
            const settingsDiv = document.getElementById('settings-info');
            settingsDiv.innerHTML = '';
            
            try {
                // Verificar se estamos no contexto da extens√£o
                if (typeof chrome === 'undefined' || !chrome.storage) {
                    settingsDiv.innerHTML += '<div class="warning"><strong>‚ö†Ô∏è Contexto da Extens√£o Necess√°rio</strong></div>';
                    settingsDiv.innerHTML += '<div class="info">Esta funcionalidade requer acesso ao chrome.storage da extens√£o.</div>';
                    settingsDiv.innerHTML += '<div class="info"><strong>Como verificar configura√ß√µes AI:</strong></div>';
                    settingsDiv.innerHTML += '<div class="info">1. Abra a extens√£o BugSpotter</div>';
                    settingsDiv.innerHTML += '<div class="info">2. Clique em "Configura√ß√µes"</div>';
                    settingsDiv.innerHTML += '<div class="info">3. Verifique as configura√ß√µes de AI</div>';
                    settingsDiv.innerHTML += '<div class="info"><strong>Configura√ß√µes importantes:</strong></div>';
                    settingsDiv.innerHTML += '<div class="info">‚Ä¢ AI Habilitada: Deve estar marcada</div>';
                    settingsDiv.innerHTML += '<div class="info">‚Ä¢ Status M√≠nimo: 400+ (captura erros 4xx e 5xx) ou 500+ (apenas 5xx)</div>';
                    settingsDiv.innerHTML += '<div class="info">‚Ä¢ API Key: Deve estar configurada</div>';
                    settingsDiv.innerHTML += '<div class="info">‚Ä¢ Auto Notifica√ß√£o: Opcional</div>';
                    return;
                }
                
                // Verificar configura√ß√µes da AI
                const settings = await chrome.storage.local.get(['ai_settings', 'ai_pause_until']);
                
                settingsDiv.innerHTML += '<div class="success"><strong>üîß Configura√ß√µes AI:</strong></div>';
                
                if (settings.ai_settings) {
                    const aiSettings = settings.ai_settings;
                    settingsDiv.innerHTML += `<div class="info">‚úÖ AI Habilitada: ${aiSettings.enabled ? 'Sim' : 'N√£o'}</div>`;
                    settingsDiv.innerHTML += `<div class="info">üìä Status M√≠nimo: ${aiSettings.minStatus || 400}+ (${aiSettings.minStatus >= 500 ? 'Apenas erros de servidor' : 'Erros de cliente e servidor'})</div>`;
                    settingsDiv.innerHTML += `<div class="info">üîî Auto Notifica√ß√£o: ${aiSettings.autoNotify ? 'Sim' : 'N√£o'}</div>`;
                    settingsDiv.innerHTML += `<div class="info">üîë API Key: ${aiSettings.apiKey ? 'Configurada' : 'N√£o configurada'}</div>`;
                    settingsDiv.innerHTML += `<div class="info">üåê Base URL: ${aiSettings.baseUrl || 'N√£o configurada'}</div>`;
                } else {
                    settingsDiv.innerHTML += '<div class="error">‚ùå Configura√ß√µes AI n√£o encontradas</div>';
                }
                
                if (settings.ai_pause_until) {
                    const pauseUntil = parseInt(settings.ai_pause_until);
                    const now = Date.now();
                    if (pauseUntil > now) {
                        const remainingMinutes = Math.ceil((pauseUntil - now) / (60 * 1000));
                        settingsDiv.innerHTML += `<div class="warning">‚è∏Ô∏è AI pausada por mais ${remainingMinutes} minutos</div>`;
                    } else {
                        settingsDiv.innerHTML += '<div class="success">‚ñ∂Ô∏è AI n√£o est√° pausada</div>';
                    }
                } else {
                    settingsDiv.innerHTML += '<div class="success">‚ñ∂Ô∏è AI n√£o est√° pausada</div>';
                }
                
            } catch (error) {
                settingsDiv.innerHTML = `<div class="error">‚ùå Erro ao verificar configura√ß√µes: ${error.message}</div>`;
            }
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('ai-analysis').innerHTML = '';
            document.getElementById('settings-info').innerHTML = '';
            testCounter = 0;
            addResult('üßπ Resultados limpos. Pronto para novos testes.');
        }
        
        // Log inicial
        console.log('ü§ñ P√°gina de valida√ß√£o de logs para AI carregada.');
        addResult('üöÄ Sistema de valida√ß√£o carregado. Execute os testes para verificar integra√ß√£o com AI.');
        
        // Verificar configura√ß√µes automaticamente
        setTimeout(checkAISettings, 1000);
    </script>
</body>
</html>